begin
sys.rqScriptDrop('CLASSBAL');
sys.rqScriptCreate('CLASSBAL',
                    'function(df,perc.over,perc.under,k,isRequired,pY,p_spltratio)
                      {
                        data1 <- ore.pull(df)
                        
                        ## Find which columns are factors
                        factor_cols <- names(data1)[sapply(data1,is.character)]            
                      
                      ## Converting training character columns to factor
                      data1[, factor_cols] <- lapply(data1[, factor_cols], as.factor) 
                        
                        p_formula <- as.formula(paste(tail(names(data1), 1) , paste(head(names(data1), -1), collapse=" + "), sep=" ~ "))
                        # Data Balance

                          library(caTools)
                          set.seed(100)
                          splt <- sample.split(Y = data1[ ,pY],SplitRatio = p_spltratio)		
                            
                        # Creation of training and validation set
                        training <- subset(x = data1,splt == TRUE)
                        
                        # Handling class Imbalance
                        library(DMwR)
                        
                        if(isRequired == "Y"){
                          data_bal <- SMOTE(form = p_formula,data = training,perc.over = perc.over,k = k,perc.under = perc.under)
                          return(data.frame(table(data_bal[,pY])))
                        }
                        else{
                          return(data.frame(table(training[,pY])))
                        }
                      }');
end;

/* Execute */

select * from table(rqTableEval(
                    cursor(select GENDER, AGE, TENURE, PERF_YR1,PERF_YR2, PERF_YR3, PERF_YR4,COMPA_BAND_YR1,COMPA_BAND_YR2,COMPA_BAND_YR3,COMPA_BAND_YR4, 
                    SICKLV_YR1,SICKLV_YR2,SICKLV_YR3,SICKLV_YR4, PROMO_L4Y, SVR_CHNG_L4Y , 
                    SALREV_L4Y , DEPT_CHNG_L4Y , ISCHURN FROM AA_COMMN_MDL_TRAIN_TBL),                    
                    cursor(select 1 as "ore.connect",400 "perc.over",200 "perc.under",20 "k",'Y' "isRequired",'ISCHURN' "pY",0.8 "p_spltratio" from dual),
                    'select CAST(1 as VARCHAR2(10)) LABEL, 1 FREQ from dual','CLASSBAL'))
